# Quality Configuration for MLX VLM Check
# This file defines thresholds and patterns used to detect quality issues in model generation.

thresholds:
  # Repetition detection
  repetition_ratio: 0.8          # 80% of tokens must be same to flag
  min_text_length: 10            # Minimum text length to check
  min_token_count: 5             # Minimum tokens to analyze

  # Phrase repetition detection (n-grams)
  min_phrase_repetitions: 3      # Minimum phrase repetitions before flagging
  max_phrase_repetitions: 10     # Flag if phrase repeats this many times regardless
  phrase_coverage_threshold: 0.4 # Minimum coverage ratio to flag (40%)
  min_phrase_length: 4           # Minimum n-gram length to check for repetition

  # Hallucination detection
  min_pipes_for_table: 4         # Minimum pipe characters to detect table
  min_table_rows: 2              # Minimum rows to confirm table structure
  min_mc_answers: 3              # Minimum multiple choice answers to flag pattern
  substantial_text_length: 200   # Text length threshold for question detection

  # Formatting violations
  max_markdown_headers: 5        # Maximum markdown headers before flagging

  # Context ignorance detection (additional)
  min_context_term_length: 2     # Minimum length for context term extraction

  # Verbosity detection
  max_verbosity_tokens: 300      # Substantial length threshold
  min_meta_patterns: 2           # Minimum meta-commentary patterns
  min_section_headers: 3         # Minimum section headers

  # Bullet point detection
  # Note: Set high for cataloging prompts that request keyword lists
  max_bullets: 25                # Maximum allowed bullet points

  # Generic output detection
  min_text_length_for_generic: 20 # Minimum text length to analyze for genericity
  generic_filler_threshold: 0.15  # Filler ratio threshold (15%)
  min_specificity_indicators: 2   # Minimum indicators for non-generic content

  # Context ignorance detection
  min_key_terms_threshold: 3      # Minimum key terms needed to evaluate context usage
  min_missing_ratio: 0.75         # Minimum ratio of missing terms (75%)

  # Confidence thresholds for output analysis
  high_confidence_threshold: 0.7  # High confidence ratio
  medium_confidence_threshold: 0.4  # Medium confidence ratio

  # Output degeneration detection thresholds
  min_text_for_degeneration: 20   # Minimum text length to check for degeneration
  min_cutoff_word_length: 2       # Words <= this at end may be cutoff
  max_control_chars: 3            # Control chars threshold before flagging
  non_ascii_ratio_threshold: 0.3  # Threshold for encoding shift detection (30%)
  non_ascii_ratio_multiplier: 3   # Multiplier for tail vs head comparison
  max_url_length: 100             # URLs longer than this are suspicious
  min_precise_stats: 2            # Number of overly precise stats to flag

  # Cataloging utility thresholds
  min_useful_words: 5             # Minimum words for useful output
  short_output_words: 15          # Output considered "short"
  substantial_prose_words: 20     # Words needed for "substantial" prose
  max_caption_words: 15           # Max words for implicit caption detection
  min_useful_chars: 10            # Minimum chars for useful output
  severe_echo_threshold: 0.8      # Echo ratio triggering severe penalty
  moderate_echo_threshold: 0.5    # Echo ratio triggering moderate penalty
  low_grounding_threshold: 0.3    # Visual grounding considered low
  low_compliance_threshold: 0.5   # Task compliance considered low
  low_info_gain_threshold: 0.3    # Information gain considered low
  grade_a_threshold: 80.0         # Score for A grade
  grade_b_threshold: 65.0         # Score for B grade
  grade_c_threshold: 50.0         # Score for C grade
  grade_d_threshold: 35.0         # Score for D grade

  # Harness/integration issue detection thresholds
  # These detect mlx-vlm bugs or model integration issues (not model quality)
  min_bpe_artifact_count: 5       # Min BPE artifacts to flag encoding issue
  min_tokens_for_substantial: 10  # Tokens below this are suspicious
  min_words_for_filler_response: 15  # Words below this in filler response
  min_words_for_truncated: 5      # Words below this = truncated output
  min_prompt_tokens_for_ratio: 100  # Prompt tokens needed for ratio check
  min_output_tokens_for_ratio: 15   # Output tokens below this with large prompt
  min_output_ratio: 0.02          # Minimum output/prompt ratio (2%)
  min_text_for_leak_detection: 100  # Min text length for training leak detection

patterns:
  # Hallucination detection
  hallucination_question_indicators:
    - "what is"
    - "how many"
    - "based on the chart"
    - "calculate"
  
  hallucination_edu_keywords:
    - "grade level"
    - "students with adhd"
    - "test scores"
    - "homework"

  # Verbosity detection
  meta_commentary:
    - "the image depicts"
    - "the image shows"
    - "the photograph captures"
    - "this image features"
    - "in conclusion"
    - "### analysis"
    - "### conclusion"
    - "based on the image"

  # Generic output detection
  filler_words:
    - "appears to"
    - "seems to"
    - "looks like"
    - "might be"
    - "could be"
    - "some"
    - "several"
    - "various"
    - "many"
    - "few"
    - "very"
    - "quite"
    - "rather"
    - "somewhat"
    - "fairly"
    - "thing"
    - "stuff"
    - "item"
    - "object"

  # Refusal detection
  refusal_explicit:
    - "i cannot"
    - "i can't"
    - "i'm unable to"
    - "i am unable to"
    - "sorry, i can't"
    - "sorry, i cannot"
  
  refusal_uncertainty:
    - "it's unclear"
    - "it's difficult to say"
    - "i'm not sure"
    - "i cannot determine"
    - "unable to determine"
    - "difficult to tell"

  refusal_insufficient_info:
    - "not enough information"
    - "insufficient detail"
    - "cannot see clearly"
    - "too blurry"
    - "image quality"

  # Language mixing / Artifacts (Regex patterns)
  tokenizer_artifacts:
    - "<\\|endoftext\\|>"
    - "<\\|end\\|>"
    - "<s>"
    - "</s>"
    - "\\[SEP\\]"
    - "\\[CLS\\]"
    - "\\[PAD\\]"
    - "\\[UNK\\]"
    - "\\[MASK\\]"
    - "<pad>"
    - "<unk>"
    - "<mask>"

  code_patterns:
    - "\\bdef\\s+\\w+\\("           # Python function definition
    - "\\bfunction\\s+\\w+\\("      # JavaScript function
    - "\\bclass\\s+\\w+"            # Class definition
    - "\\bimport\\s+\\w+"           # Import statement
    - "\\breturn\\s+"               # Return statement
