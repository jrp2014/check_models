name: Dependency Sync Guard

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  sync-check:
    name: Verify README dependency blocks are in sync with pyproject
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install core tooling
        run: |
          python -m pip install --upgrade pip
          pip install tomli ruff

      - name: Run dependency sync script
        run: |
          python -m vlm.tools.update_readme_deps

      - name: Run dependency sync verification
        run: |
          python -m vlm.tools.check_dependency_sync

      - name: Detect uncommitted changes after sync
        run: |
          if ! git diff --exit-code --quiet; then
            echo '::error ::README dependency blocks are out of sync with pyproject.toml. Run python -m vlm.tools.update_readme_deps and commit the result.'
            echo 'Modified files:'
            git diff --name-only
            exit 1
          fi

      - name: Ruff lint (sync utilities)
        run: |
          ruff check vlm/tools/update_readme_deps.py vlm/tools/check_dependency_sync.py
