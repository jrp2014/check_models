name: Dependency Sync Guard

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-check:
    name: Verify README dependency blocks are in sync with pyproject
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install core tooling
        run: |
          python -m pip install --upgrade pip
          pip install tomli

      - name: Run dependency sync script
        run: |
          cd src
          python -m tools.update_readme_deps

      - name: Detect uncommitted changes after sync
        run: |
          if ! git diff --exit-code --quiet; then
            echo '::error ::README dependency blocks are out of sync with pyproject.toml. Run "cd src && python -m tools.update_readme_deps" and commit the result.'
            echo 'Modified files:'
            git diff --name-only
            exit 1
          fi
